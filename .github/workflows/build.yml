name: Build & Package ImpellerSharp

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: 1

jobs:
  native:
    name: Build native (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos
            runner: macos-latest
            platform: macos
            arch: arm64
          - os: linux
            runner: ubuntu-22.04
            platform: linux
            arch: x64
          - os: windows
            runner: windows-latest
            platform: windows
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Add depot_tools to PATH (Unix)
        if: matrix.os != 'windows'
        run: echo "${{ github.workspace }}/extern/depot_tools" >> $GITHUB_PATH
        shell: bash

      - name: Add depot_tools to PATH (Windows)
        if: matrix.os == 'windows'
        run: Add-Content $env:GITHUB_PATH "$env:GITHUB_WORKSPACE\extern\depot_tools"

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install ninja python@3.11
        shell: bash

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip ninja-build clang pkg-config

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install -y ninja python --no-progress

      - name: Build native Impeller (Unix)
        if: matrix.os != 'windows'
        run: >
          python3 build/native/build_impeller.py
          --platform ${{ matrix.platform }}
          --arch ${{ matrix.arch }}
          --configuration Release

      - name: Build native Impeller (Windows)
        if: matrix.os == 'windows'
        run: >
          python build/native/build_impeller.py
          --platform ${{ matrix.platform }}
          --arch ${{ matrix.arch }}
          --configuration Release

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.os }}
          path: artifacts/native/**

  native_rive:
    name: Build Rive native (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos
            runner: macos-latest
            platform: macos
            arch: arm64
          - os: linux
            runner: ubuntu-22.04
            platform: linux
            arch: x64
          - os: windows
            runner: windows-latest
            platform: windows
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install cmake ninja python@3.11
        shell: bash

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip ninja-build cmake build-essential

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install -y ninja cmake python --no-progress

      - name: Cache Rive build
        uses: actions/cache@v4
        with:
          path: |
            extern/rive/out
          key: rive-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('build/rive/build_rive.py') }}
          restore-keys: |
            rive-${{ runner.os }}-${{ matrix.arch }}-

      - name: Build Rive (Unix)
        if: matrix.os != 'windows'
        run: >
          python3 build/rive/build_rive.py
          --platform ${{ matrix.platform }}
          --arch ${{ matrix.arch }}
          --configuration Release

      - name: Build Rive (Windows)
        if: matrix.os == 'windows'
        run: >
          python build/rive/build_rive.py
          --platform ${{ matrix.platform }}
          --arch ${{ matrix.arch }}
          --configuration Release

      - name: Upload Rive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-rive-${{ matrix.os }}
          path: artifacts/rive/**

  managed_tests:
    name: Managed Build & Tests
    runs-on: ubuntu-22.04
    needs:
      - native
      - native_rive

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Impeller artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: artifacts/native
          merge-multiple: true

      - name: Download Rive artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-rive-*
          path: artifacts/rive
          merge-multiple: true

      - name: Stage native assets
        run: python3 build/managed/stage_native_assets.py --configuration Release

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build solution
        run: dotnet build ImpellerSharp.sln -c Release

      - name: Run tests
        run: dotnet test ImpellerSharp.sln -c Release --no-build --logger trx --results-directory artifacts/test-results

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: artifacts/test-results

  pack:
    name: Pack NuGet
    runs-on: ubuntu-22.04
    needs:
      - native
      - native_rive
      - managed_tests
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: artifacts/native
          merge-multiple: true

      - name: Download Rive artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-rive-*
          path: artifacts/rive
          merge-multiple: true

      - name: Stage native assets
        run: python3 build/managed/stage_native_assets.py --configuration Release

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Pack NuGet packages
        run: python3 build/managed/package_all.py --configuration Release

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: artifacts/nuget

      - name: Upload packaging manifest
        uses: actions/upload-artifact@v4
        with:
          name: nuget-manifest
          path: artifacts/nuget/manifest.json
